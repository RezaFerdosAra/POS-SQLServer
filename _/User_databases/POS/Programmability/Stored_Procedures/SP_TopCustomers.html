<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></meta>
    <title>pub.SP_TopCustomers</title>
    <link rel="stylesheet" href="../../../../../Style/Master.css" type="text/css">
    <script src="../../../../../Scripts/jquery-1.9.1.js" type="text/javascript"></script>
    <script src="../../../../../Scripts/sections.js" type="text/javascript"></script>
</head>
<body>
    <div id="wrap">
        <div id="container">
            <div id="header">
                <div id="breadcrumbs">
                    Project &gt; Database Properties &gt; Programmability &gt; Stored Procedures &gt; pub.SP_TopCustomers
                </div>
                <div id="headerText">
                    Author: &#160;Reza FerdosAra
                </div>
            </div>

            <div id="pageTitle">
                <img src="../../../../../Images/StoredProcedure32.png" alt="Stored Procedures" title="Stored Procedures" class="StoredProcedure32"> 
                [pub].[SP_TopCustomers]
            </div>

            <div class="panel panel-default panel-collapsible">
                <div class="panel-heading">
                    <div class="expandCollapse">
                        <img src="../../../../../Images/collapsed.png" alt="collapsed" title="collapsed" class="collapsed" style="display:none;">
                        <img src="../../../../../Images/expanded.png" alt="expanded" title="expanded" class="expanded" style="">
                    </div>
                    <a name="properties">Properties</a>
                </div>
                <div class="panel-body">
                    <table cellspacing="1" border="0" class="dataTable table-hover">
                        <tbody>
                            <tr>
                                <th>Property</th>
                                <th>Value</th>
                            </tr>
                            <tr>
                                <td>ANSI Nulls On</td>
                                <td><span class="do-yes">True</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="panel panel-default panel-collapsible">
                <div class="panel-heading">
                    <div class="expandCollapse">
                        <img src="../../../../../Images/collapsed.png" alt="collapsed" title="collapsed" class="collapsed" style="display:none;">
                        <img src="../../../../../Images/expanded.png" alt="expanded" title="expanded" class="expanded" style="">
                    </div>
                    <a name="parameters">Parameters</a>
                </div>
                <div class="panel-body">
                    <table cellspacing="1" border="0" class="dataTable table-hover">
                        <tbody>
                            <tr>
                                <th>Name</th>
                                <th>Data Type</th>
                                <th>Max Length (Bytes)</th>
                            </tr>
                            <tr>
                                <td>@TopCount</td>
                                <td>int</td>
                                <td>4</td>
                            </tr>
                            <tr>
                                <td>@FromDate</td>
                                <td>datetime2</td>
                                <td>8</td>
                            </tr>
                            <tr>
                                <td>@EndDate</td>
                                <td>datetime2</td>
                                <td>8</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>




<div class="panel panel-default panel-collapsible">
    <div class="panel-heading">
        <div class="expandCollapse">
            <img src="../../../../../Images/collapsed.png" alt="collapsed" title="collapsed" class="collapsed" style="display:none;">
            <img src="../../../../../Images/expanded.png" alt="expanded" title="expanded" class="expanded" style="">
        </div>
        <a name="sqlscript">SQL Script</a>
    </div>
    <div class="panel-body">
        <div id="sqlScript">
            <span class="sqlScriptsKeyword">CREATE</span>&nbsp;&nbsp;
            <span class="sqlScriptsKeyword">PROC</span>&nbsp;
            <span class="sqlScriptsNormal">[pub]</span><span class="sqlScriptsOperator">.</span><span class="sqlScriptsNormal">[SP_TopCustomers]</span>&nbsp;
            <span class="sqlScriptsNormal">@TopCount</span>&nbsp;<span class="sqlScriptsKeyword">INT</span>&nbsp;<span class="sqlScriptsOperator">=</span>&nbsp;<span class="sqlScriptsNumber">10</span><span class="sqlScriptsNormal">,</span>&nbsp;
            <span class="sqlScriptsNormal">@FromDate</span>&nbsp;<span class="sqlScriptsKeyword">DATETIME2</span>&nbsp;<span class="sqlScriptsOperator">=</span>&nbsp;<span class="sqlScriptsKeyword">NULL</span><span class="sqlScriptsNormal">,</span>&nbsp;
            <span class="sqlScriptsNormal">@EndDate</span>&nbsp;<span class="sqlScriptsKeyword">DATETIME2</span>&nbsp;<span class="sqlScriptsOperator">=</span>&nbsp;<span class="sqlScriptsKeyword">NULL</span>&nbsp;
            <span class="sqlScriptsComment">-- Fomrat '1996-07-31'</span><br>

            <span class="sqlScriptsKeyword">WITH</span>&nbsp;<span class="sqlScriptsKeyword">ENCRYPTION</span><br>
            <span class="sqlScriptsKeyword">AS</span><br>
            <span class="sqlScriptsKeyword">BEGIN</span><br>
            &nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span>&nbsp;<span class="sqlScriptsKeyword">NOCOUNT</span>&nbsp;<span class="sqlScriptsKeyword">ON</span><br>
            &nbsp;&nbsp;<span class="sqlScriptsOperator">;</span><span class="sqlScriptsKeyword">WITH</span>&nbsp;<span class="sqlScriptsNormal">t</span>&nbsp;<span class="sqlScriptsKeyword">AS</span>&nbsp;<span class="sqlScriptsOperator">(</span><br>

            &nbsp;&nbsp;<span class="sqlScriptsKeyword">SELECT</span>&nbsp;<span class="sqlScriptsNormal">i.InvoiceID</span><span class="sqlScriptsNormal">,</span><br>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">i.CustomerID</span><span class="sqlScriptsNormal">,</span><br>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">i.InvoiceDate</span>&nbsp;<span class="sqlScriptsKeyword">AS</span>&nbsp;<span class="sqlScriptsNormal">Last_Invoice</span><span class="sqlScriptsNormal">,</span>&nbsp;
            <span class="sqlScriptsKeyword">COUNT</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">ii.InvoiceItemID</span><span class="sqlScriptsOperator">)</span>&nbsp;<span class="sqlScriptsKeyword">AS</span>&nbsp;<span class="sqlScriptsNormal">Product_Count</span><span class="sqlScriptsNormal">,</span>&nbsp;
            <span class="sqlScriptsKeyword">SUM</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">ii.LineTotal</span><span class="sqlScriptsOperator">)</span>&nbsp;<span class="sqlScriptsKeyword">AS</span>&nbsp;<span class="sqlScriptsNormal">TotalPrice</span><br>

            &nbsp;&nbsp;<span class="sqlScriptsKeyword">FROM</span>&nbsp;<span class="sqlScriptsNormal">finance.Invoices</span>&nbsp;<span class="sqlScriptsNormal">i</span>&nbsp;
            <span class="sqlScriptsKeyword">JOIN</span>&nbsp;<span class="sqlScriptsNormal">finance.InvoiceItems</span>&nbsp;<span class="sqlScriptsNormal">ii</span>&nbsp;
            <span class="sqlScriptsKeyword">ON</span>&nbsp;<span class="sqlScriptsNormal">i.InvoiceID</span>&nbsp;<span class="sqlScriptsOperator">=</span>&nbsp;<span class="sqlScriptsNormal">ii.InvoiceID</span><br>

            &nbsp;&nbsp;<span class="sqlScriptsKeyword">WHERE</span>&nbsp;<span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">i.InvoiceDate</span>&nbsp;<span class="sqlScriptsKeyword">BETWEEN</span>&nbsp;<span class="sqlScriptsNormal">@FromDate</span>&nbsp;<span class="sqlScriptsKeyword">AND</span>&nbsp;<span class="sqlScriptsNormal">@EndDate</span><span class="sqlScriptsOperator">)</span>&nbsp;
            <span class="sqlScriptsKeyword">AND</span>&nbsp;<span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">i.Payment_Status</span>&nbsp;<span class="sqlScriptsOperator">=</span>&nbsp;<span class="sqlScriptsNumber">2</span><span class="sqlScriptsOperator">)</span><br>

            &nbsp;&nbsp;<span class="sqlScriptsKeyword">GROUP BY</span>&nbsp;<span class="sqlScriptsNormal">i.InvoiceID</span><span class="sqlScriptsNormal">,</span>&nbsp;
            <span class="sqlScriptsNormal">i.CustomerID</span><span class="sqlScriptsNormal">,</span>&nbsp;
            <span class="sqlScriptsNormal">i.InvoiceDate</span><br>

            &nbsp;&nbsp;<span class="sqlScriptsOperator">)</span><span class="sqlScriptsNormal">,</span>&nbsp;<span class="sqlScriptsNormal">t2</span>&nbsp;<span class="sqlScriptsKeyword">AS</span>&nbsp;<span class="sqlScriptsOperator">(</span><br>
            &nbsp;&nbsp;<span class="sqlScriptsKeyword">SELECT</span>&nbsp;<span class="sqlScriptsNormal">CustomerID</span><span class="sqlScriptsNormal">,</span>&nbsp;
            <span class="sqlScriptsKeyword">MAX</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">Last_Invoice</span><span class="sqlScriptsOperator">)</span>&nbsp;<span class="sqlScriptsKeyword">AS</span>&nbsp;<span class="sqlScriptsNormal">Last_Invoice</span><span class="sqlScriptsNormal">,</span>&nbsp;
            <span class="sqlScriptsKeyword">SUM</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">Product_Count</span><span class="sqlScriptsOperator">)</span>&nbsp;<span class="sqlScriptsKeyword">AS</span>&nbsp;<span class="sqlScriptsNormal">Product_Count</span><span class="sqlScriptsNormal">,</span>&nbsp;
            <span class="sqlScriptsKeyword">SUM</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">TotalPrice</span><span class="sqlScriptsOperator">)</span>&nbsp;<span class="sqlScriptsKeyword">AS</span>&nbsp;<span class="sqlScriptsNormal">TotalPrice</span><span class="sqlScriptsNormal">,</span>&nbsp;
            <span class="sqlScriptsKeyword">COUNT</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">InvoiceID</span><span class="sqlScriptsOperator">)</span>&nbsp;<span class="sqlScriptsKeyword">AS</span>&nbsp;<span class="sqlScriptsNormal">Total_Invoice</span><br>

            &nbsp;&nbsp;<span class="sqlScriptsKeyword">FROM</span>&nbsp;<span class="sqlScriptsNormal">t</span><br>
            &nbsp;&nbsp;<span class="sqlScriptsKeyword">GROUP BY</span>&nbsp;<span class="sqlScriptsNormal">CustomerID</span><br>
            &nbsp;&nbsp;<span class="sqlScriptsOperator">)</span><br>

            &nbsp;&nbsp;<span class="sqlScriptsKeyword">SELECT</span>&nbsp;<span class="sqlScriptsKeyword">TOP</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@TopCount</span><span class="sqlScriptsOperator">)</span>&nbsp;<span class="sqlScriptsKeyword">WITH</span>&nbsp;<span class="sqlScriptsKeyword">TIES</span>&nbsp;
            <span class="sqlScriptsNormal">t2.CustomerID</span>&nbsp;<span class="sqlScriptsKeyword">AS</span>&nbsp;<span class="sqlScriptsNormal">CID</span><span class="sqlScriptsNormal">,</span>&nbsp;
            <span class="sqlScriptsNormal">c.FullName</span><span class="sqlScriptsNormal">,</span>&nbsp;
            <span class="sqlScriptsNormal">Last_Invoice</span><span class="sqlScriptsNormal">,</span>&nbsp;
            <span class="sqlScriptsNormal">Product_Count</span><span class="sqlScriptsNormal">,</span>&nbsp;
            <span class="sqlScriptsNormal">TotalPrice</span><span class="sqlScriptsNormal">,</span>&nbsp;
            <span class="sqlScriptsNormal">Total_Invoice</span><br>

            &nbsp;&nbsp;<span class="sqlScriptsKeyword">FROM</span>&nbsp;<span class="sqlScriptsNormal">t2</span>&nbsp;
            <span class="sqlScriptsKeyword">JOIN</span>&nbsp;<span class="sqlScriptsNormal">[identity].Customers</span>&nbsp;<span class="sqlScriptsNormal">c</span>&nbsp;
            <span class="sqlScriptsKeyword">ON</span>&nbsp;<span class="sqlScriptsNormal">t2.CustomerID</span>&nbsp;<span class="sqlScriptsOperator">=</span>&nbsp;<span class="sqlScriptsNormal">c.CustomerID</span><br>

            &nbsp;&nbsp;<span class="sqlScriptsKeyword">ORDER BY</span>&nbsp;<span class="sqlScriptsNormal">TotalPrice</span>&nbsp;<span class="sqlScriptsKeyword">DESC</span><span class="sqlScriptsNormal">,</span>&nbsp;
            <span class="sqlScriptsNormal">Product_Count</span>&nbsp;<span class="sqlScriptsKeyword">DESC</span><span class="sqlScriptsNormal">,</span>&nbsp;
            <span class="sqlScriptsNormal">Last_Invoice</span>&nbsp;<span class="sqlScriptsKeyword">DESC</span><br>

            <span class="sqlScriptsKeyword">END</span><br>
            <span class="sqlScriptsNormal">GO</span><br>
        </div>
    </div>
</div>






        </div>
    </div>

    <div id="footer">
        <div class="row">
            <div id="customtext" class="col-sm-4">
                <div id="projectauthor"></div>
            </div>
            <div id="copyright" class="col-sm-4">&#160;rezaferdosara.ir</div>
            <div id="date" class="col-sm-4">Created: 8/3/2025 7:53:00 PM</div>
        </div>
    </div>
</body>
</html>
